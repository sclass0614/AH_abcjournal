<!DOCTYPE html>

<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <title>우리집 DayCareCenter</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <link rel="stylesheet" href="style.css"/>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
    <script src="supabase.js"></script>
    <script type="module" src="https://sclass0614.github.io/authCheck/authCheck.js"></script>
  </head>

  <body>
    <div id="loadingOverlay">
      <div class="loader"></div>
      <div>데이터를 처리중입니다...</div>
    </div>

    <header>
      <h1>
        <i class="fas fa-home header-icon"></i>
        우리집 DayCareCenter
      </h1>
    </header>

    <div id="customAlertModal" class="custom-alert">
      <div class="custom-alert-content">
        <div class="custom-alert-header">
          <i class="fas fa-info-circle"></i>
          <span>알림</span>
          <button class="close-alert">&times;</button>
        </div>
        <div class="custom-alert-body">
          <p id="alertMessage"></p>
            </div>
        <div class="custom-alert-footer">
          <button class="alert-confirm-btn" onclick="closeCustomAlert()">
            확인
          </button>
        </div>
      </div>
    </div>

    <div id="customConfirmModal" class="custom-alert">
      <div class="custom-alert-content">
        <div class="custom-alert-header confirm-header">
          <i class="fas fa-question-circle"></i>
          <span>확인</span>
          <button class="close-alert" onclick="closeCustomConfirm(false)">&times;</button>
        </div>
        <div class="custom-alert-body">
          <p id="confirmMessage"></p>
          </div>
        <div class="custom-alert-footer">
          <button class="alert-cancel-btn" onclick="closeCustomConfirm(false)">
            취소
          </button>
          <button class="alert-confirm-btn confirm-btn" onclick="closeCustomConfirm(true)">
            확인
          </button>
        </div>
      </div>
    </div>

    <div id="memberSelectModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3>회원 선택</h3>
          <span class="close-member-modal">&times;</span>
        </div>
        <input
          type="text"
          id="memberSearchBox"
          class="search-box"
          placeholder="회원 검색 (이름 또는 회원번호)..."
        />
        <div class="table-container modal-table-container">
          <table class="list-table" id="member-list-table">
            <thead>
              <tr>
                <th>회원번호</th>
                <th>회원명</th>
              </tr>
            </thead>
            <tbody id="member-list-body">
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <div id="staffSelectModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3>직원명 선택</h3>
          <span class="close-staff-modal">&times;</span>
        </div>
        <input
          type="text"
          id="staffSearchBox"
          class="search-box"
          placeholder="직원명 검색 (이름 또는 직원번호)..."
        />
        <div class="table-container modal-table-container">
          <table class="list-table" id="staff-list-table">
            <thead>
              <tr>
                <th>직원번호</th>
                <th>이름</th>
              </tr>
            </thead>
            <tbody id="staff-list-body">
            </tbody>
          </table>
        </div>
        <div class="button-container">
          <button id="resetManagerBtn">
            초기화
          </button>
        </div>
      </div>
    </div>

    <main>
      <section class="page active" id="page2">
        <div class="header-container">
          <h2>Journal Report</h2>
          <div class="date-search-container">
            <input
              type="date"
              id="datePickerPage2"
              onchange="journalSearch()"
            />
            <div style="display: flex; align-items: center; gap: 10px;">
              <button id="btn-journal-search">
                <i class="fas fa-sync-alt"></i> 업데이트
              </button>
              <input
                type="text"
                id="employeeFilter"
                placeholder="직원번호필터링"
                onkeyup="filterJournalAndPlanByEmployee()"
              />
            </div>
          </div>
        </div>

        <div class="panel thick-border">
          <div class="table-container">
            <table id="daily-journal-table">
              <thead>
                <tr>
                  <th onclick="sortJournalTable(0)">날짜</th>
                  <th onclick="sortJournalTable(1)">시작시간</th>
                  <th onclick="sortJournalTable(2)">종료시간</th>
                  <th onclick="sortJournalTable(3)">직원명</th>
                  <th onclick="sortJournalTable(4)">활동명</th>
                  <th onclick="sortJournalTable(5)">소분류코드</th>
                  <th onclick="sortJournalTable(6)">회원번호</th>
                  <th onclick="sortJournalTable(7)">이름</th>
                  <th onclick="sortJournalTable(8)">참여도</th>
                  <th onclick="sortJournalTable(9)">수행도</th>
                  <th onclick="sortJournalTable(10)">만족도</th>
                  <th onclick="sortJournalTable(11)">관찰사항</th>
                </tr>
              </thead>
              <tbody id="journal-table-body">
              </tbody>
            </table>
          </div>
        </div>

        <div class="three-panel">
          <div class="panel" id="daily-plan-container">
            <h3>Daily Plan</h3>
            <div class="table-container plan-table-container">
              <table id="daily-plan-summary-table">
                <thead>
                  <tr>
                    <th onclick="sortPlanSummaryTable(0)">날짜</th>
                    <th onclick="sortPlanSummaryTable(1)">시작시간</th>
                    <th onclick="sortPlanSummaryTable(2)">종료시간</th>
                    <th onclick="sortPlanSummaryTable(3)">직원명</th>
                    <th onclick="sortPlanSummaryTable(4)">활동명</th>
                    <th onclick="sortPlanSummaryTable(5)">소분류코드</th>
                  </tr>
                </thead>
                <tbody id="plan-table-body">
                </tbody>
              </table>
            </div>
          </div>

          <div class="panel" id="plan-to-journal-container">
            <h3>Plan to Journal</h3>
            <div class="row-2col">
              <div class="col-2">
                <label>날짜(조회)</label>
                <input
                  type="text"
                  id="journalDate"
                  placeholder="우측상단 날짜 선택 후 조회"
                  readonly
                />
              </div>
              <div class="col-2" style="visibility: hidden;">
                <label>일지_ID(자동입력)</label>
                <input
                  type="text"
                  id="journalID"
                  placeholder="일지_ID 입력중..."
                  readonly
                  style="height: 31px;"
                />
              </div>
            </div>
            <div class="row-2col">
              <div class="col-2">
                <label>시작시간</label>
                <input
                  type="text"
                  id="journalStartTime"
                  placeholder="시간 입력중... ex)0920"
                />
              </div>
              <div class="col-2">
                <label>종료시간</label>
                <input
                  type="text"
                  id="journalEndTime"
                  placeholder="시간 입력중... ex)1800"
                />
              </div>
            </div>
            <div class="row-2col">
              <div class="col-2">
                <label>직원명</label>
                <input
                  type="text"
                  id="journalManager"
                  placeholder="직원명 입력중..."
                  readonly
                />
                <input
                  type="hidden"
                  id="journalEmployeeNumber"
                />
              </div>
              <div class="col-2">
                <label>활동명</label>
                <input
                  type="text"
                  id="journalActivityName"
                  placeholder="활동명 입력중..."
                  readonly
                />
              </div>
              <div class="col-2">
                <label>소분류코드</label>
                <input
                  type="text"
                  id="journalCode"
                  placeholder="소분류코드 선택..."
                  readonly
                />
              </div>
            </div>
            <div class="row-2col">
              <div class="col-2">
                <label>회원번호</label>
                <input
                  type="text"
                  id="journalMemberNumber"
                  placeholder="성함을 클릭하세요"
                  readonly
                />
              </div>
              <div class="col-2">
                <label>성함</label>
                <input
                  type="text"
                  id="journalName"
                  placeholder="클릭!"
                  readonly
                />
              </div>
            </div>
            <div class="score-container">
              <label class="score-label">참여도</label>
            <input
                type="number"
                id="journalParticipation"
                class="score-input"
                min="0"
                max="5"
                value="5"
              />
              <label class="score-label">수행도</label>
            <input
                type="number"
                id="journalPerformance"
                class="score-input"
                min="0"
                max="5"
                value="5"
              />
              <label class="score-label">만족도</label>
              <input
                type="number"
                id="journalSatisfaction"
                class="score-input"
                min="0"
                max="5"
                value="5"
            />
          </div>
            <label>관찰사항</label>
            <textarea id="journalObservations" rows="1"></textarea>
          </div>
          </div>

        <div class="bottom-buttons">
              <button
            id="btn-journal-reset"
            onclick="resetAllFields()"
              >
            초기화
              </button>
              <button
            id="btn-journal-save-new"
              >
            신규저장
              </button>
              <button
            id="btn-journal-modify"
            class="btn btn-primary btn-sm"
              >
            기존 Journal 수정
              </button>
            <button
            id="btn-journal-delete"
              >
            기존 Journal 삭제
            </button>
          </div>
      </section>
    </main>
    <script>
      let dailyPlanAll = [];
      let dailyjournalAll = [];
      let memberall = [];

      async function getPlanAllPromise(date = null) {
          return await getPlanAll(date);
      }

      async function getJournalAllPromise(date = null) {
          return await getJournalAll(date);
      }

      async function getMembersPromise() {
          return await getAllMembers();
      }

      async function initialize() {
          showLoading();
          
          try {
              memberall = await getMembersPromise();
          } catch (error) {
              showCustomAlert("데이터를 불러오는데 실패했습니다: " + error);
          } finally {
              hideLoading();
          }
      }

      async function getPlanAll_id(date = null) {
          showLoading();
          try {
              dailyPlanAll = await getPlanAllPromise(date);
              makeTable_plan();
          } catch (error) {
              showCustomAlert("데이터를 불러오는데 실패했습니다: " + error);
          } finally {
              hideLoading();
          }
      }

      async function getJournalAll_id(date = null) {
          showLoading();
          try {
              dailyjournalAll = await getJournalAllPromise(date);
              makeTable_journal();
              return true;
          } catch (error) {
              showCustomAlert("일지 데이터를 불러오는데 실패했습니다: " + error);
              return false;
          } finally {
              hideLoading();
          }
      }

      async function getMember_id() {
          showLoading();
          try {
              memberall = await getMembersPromise();
          } catch (error) {
              showCustomAlert("회원 데이터를 불러오는데 실패했습니다: " + error);
          } finally {
              hideLoading();
          }
      }

      function makeTable_plan() {
        const selectedDate = changeDate(document.getElementById("datePickerPage2").value);
        
        const tableBody = document.getElementById('plan-table-body');
        tableBody.innerHTML = '';
        
        if (!selectedDate) {
          return;
        }
        
        const filteredPlans = dailyPlanAll;
        
        if (filteredPlans.length === 0) {
          const row = document.createElement('tr');
          const cell = document.createElement('td');
          cell.colSpan = 6;
          cell.textContent = '해당 날짜의 계획 데이터가 없습니다.';
          cell.style.textAlign = 'center';
          cell.style.padding = '10px';
          row.appendChild(cell);
          tableBody.appendChild(row);
          
          if (document.getElementById("planDate")) {
            document.getElementById("planDate").value = selectedDate;
          }
          return;
        }
        
        filteredPlans.sort((a, b) => {
          const startTimeA = String(a.시작시간 || '').padStart(4, '0');
          const startTimeB = String(b.시작시간 || '').padStart(4, '0');
          const timeA = timeToNumber(startTimeA);
          const timeB = timeToNumber(startTimeB);
          const timeCompare = timeA - timeB;
          
          if (timeCompare === 0) {
            const managerA = String(a.직원명 || '');
            const managerB = String(b.직원명 || '');
            return managerA.localeCompare(managerB);
          }
          
          return timeCompare;
        });
        
        filteredPlans.forEach(plan => {
          const row = document.createElement('tr');
          
          const columns = ['날짜', '시작시간', '종료시간', '직원명', '활동명', '생활영역'];
          
          columns.forEach(key => {
            const cell = document.createElement('td');
            if (key === '날짜') {
              cell.textContent = plan[key] || '';
            } else if (key === '시작시간' || key === '종료시간') {
              cell.textContent = String(plan[key] || '').padStart(4, '0');
            } else {
              cell.textContent = plan[key] || '';
            }
            row.appendChild(cell);
          });
          
          row.addEventListener('dblclick', () => {
            resetAllFields();
            document.getElementById('journalDate').value = plan.날짜 || '';
            document.getElementById('journalStartTime').value = String(plan.시작시간 || '').padStart(4, '0');
            document.getElementById('journalEndTime').value = String(plan.종료시간 || '').padStart(4, '0');
            document.getElementById('journalEmployeeNumber').value = plan.직원번호 || '';
            document.getElementById('journalManager').value = plan.직원명 || '';
            document.getElementById('journalActivityName').value = plan.활동명 || '';
            document.getElementById('journalCode').value = plan.생활영역 || '';
          });
          
          tableBody.appendChild(row);
        });
        
        if (document.getElementById("planDate")) {
          document.getElementById("planDate").value = selectedDate;
        }
      }

      function makeTable_journal() {
          filterJournalByEmployee();
      }

      async function journalSearch() {
        const date = document.getElementById('datePickerPage2').value;
        const dateYmd = changeDate(date);
        
        document.getElementById('employeeFilter').value = '';
        
        if (dateYmd) {
          await getPlanAll_id(dateYmd);
          await getJournalAll_id(dateYmd);
        }
        
        makeTable_journal();
      }

      function showLoading() {
          const loadingOverlay = document.getElementById('loadingOverlay');
          if (loadingOverlay) {
              loadingOverlay.style.display = 'flex';
          }
      }

      function hideLoading() {
          const loadingOverlay = document.getElementById('loadingOverlay');
          if (loadingOverlay) {
              loadingOverlay.style.display = 'none';
          }
      }

      let confirmCallback = null;

      function showCustomAlert(message) {
          const modal = document.getElementById('customAlertModal');
          const messageElement = document.getElementById('alertMessage');
          messageElement.textContent = message;
          modal.style.display = 'flex';
      }

      function closeCustomAlert() {
          const modal = document.getElementById('customAlertModal');
          modal.style.display = 'none';
      }

      function showCustomConfirm(message, onConfirm) {
          const modal = document.getElementById('customConfirmModal');
          const messageElement = document.getElementById('confirmMessage');
          messageElement.textContent = message;
          confirmCallback = onConfirm;
          modal.style.display = 'flex';
      }

      function closeCustomConfirm(result) {
          const modal = document.getElementById('customConfirmModal');
          modal.style.display = 'none';
          if (confirmCallback && result) {
              confirmCallback();
          }
          confirmCallback = null;
      }

      function updateButtonStates(saveEnabled, modifyEnabled, deleteEnabled) {
          const saveButton = document.getElementById('btn-journal-save-new');
          const modifyButton = document.getElementById('btn-journal-modify');
          const deleteButton = document.getElementById('btn-journal-delete');
          
          if (saveButton) saveButton.disabled = !saveEnabled;
          if (modifyButton) modifyButton.disabled = !modifyEnabled;
          if (deleteButton) deleteButton.disabled = !deleteEnabled;
      }

      function disableButtonTemporarily(buttonId, duration = 2000) {
          const button = document.getElementById(buttonId);
          if (button) {
              button.disabled = true;
              setTimeout(() => {
                  button.disabled = false;
              }, duration);
          }
      }

      document.addEventListener('DOMContentLoaded', async function() {
        
        const today = new Date().toISOString().split("T")[0];
        const todayYmd = changeDate(today);
        document.getElementById("datePickerPage2").value = today;

        updateButtonStates(true, false, false);

        await initialize();
        
        if (todayYmd) {
          await getPlanAll_id(todayYmd);
          await getJournalAll_id(todayYmd);
        }
        
        document.getElementById('journalName').addEventListener('click', showMemberModal);
        
        document.getElementById('memberSearchBox').addEventListener('input', function() {
            const selectedDate = changeDate(document.getElementById("datePickerPage2").value);
            updateMemberList(selectedDate);
        });

        document.querySelector('.close-member-modal').addEventListener('click', closeMemberModal);

        window.addEventListener('click', function(event) {
            const alertModal = document.getElementById('customAlertModal');
            const confirmModal = document.getElementById('customConfirmModal');
            if (event.target === alertModal) {
                closeCustomAlert();
            } else if (event.target === confirmModal) {
                closeCustomConfirm(false);
            }
        });

        document.getElementById("btn-journal-save-new").addEventListener("click", async function() {
            try {
                await appendJournal_id();
            } catch (error) {
            } finally {
                disableButtonTemporarily('btn-journal-save-new');
            }
        });

        document.getElementById("btn-journal-modify").addEventListener("click", async function() {
            try {
                await updateJournal_id();
            } catch (error) {
            } finally {
                disableButtonTemporarily('btn-journal-modify');
            }
        });

        document.getElementById("btn-journal-delete").addEventListener("click", async function() {
            try {
                await deleteJournalrow_id();
            } catch (error) {
            } finally {
                disableButtonTemporarily('btn-journal-delete');
            }
        });

        document.getElementById('btn-journal-search').addEventListener('click', async function() {
            document.getElementById('employeeFilter').value = '';
            
            const currentDate = changeDate(document.getElementById("datePickerPage2").value);
            if (currentDate) {
                await getPlanAll_id(currentDate);
                await getJournalAll_id(currentDate);
            }
            
            await getMember_id();
        });
        const tableHeaders = document.querySelectorAll('#daily-journal-table th, #daily-plan-summary-table th');
        tableHeaders.forEach(header => {
          header.style.cursor = 'pointer';
          header.title = '클릭하여 정렬';
        });
      });

      function changeDate(dateStr) {
          if (!dateStr) return '';

          if (typeof dateStr !== 'string') {
            dateStr = String(dateStr);
          }

          return dateStr.replace(/-/g, "");
        }
        
      function convertTimeToMinutes(timeStr) {
          const hours = parseInt(timeStr.substring(0, 2));
          const minutes = parseInt(timeStr.substring(2, 4));
          return hours * 60 + minutes;
      }

      function timeToNumber(timeStr) {
          if (!timeStr) return 0;
          return parseInt(timeStr);
      }

      function formatTime(timeStr) {
          return `${timeStr.substring(0, 2)}:${timeStr.substring(2, 4)}`;
      }

      function checkRightTimeAndMemberNum() {
          const journalDate = document.getElementById("journalDate").value;
          const startTime = document.getElementById("journalStartTime").value.padStart(4, '0');
          const endTime = document.getElementById("journalEndTime").value.padStart(4, '0');
          const memberNumber = document.getElementById("journalMemberNumber").value;
          const currentJournalId = document.getElementById("journalID").value;
          
          const inputStartMinutes = convertTimeToMinutes(startTime);
          const inputEndMinutes = convertTimeToMinutes(endTime);
          
          const sameDateJournals = dailyjournalAll.filter(journal => journal.날짜 == journalDate && journal.회원번호 === memberNumber);
          
          for (const journal of sameDateJournals) {
              if (currentJournalId && journal.일지_id === currentJournalId) {
                  continue;
              }
              
              const journalStartTime = String(journal.시작시간 || '').padStart(4, '0');
              const journalEndTime = String(journal.종료시간 || '').padStart(4, '0');
              const journalStartMinutes = convertTimeToMinutes(journalStartTime);
              const journalEndMinutes = convertTimeToMinutes(journalEndTime);
              
              if ((inputStartMinutes >= journalStartMinutes && inputStartMinutes < journalEndMinutes) ||
                  (inputEndMinutes > journalStartMinutes && inputEndMinutes <= journalEndMinutes) ||
                  (inputStartMinutes <= journalStartMinutes && inputEndMinutes >= journalEndMinutes)) {
                  
                  const journalStartTimeFormatted = formatTime(journalStartTime);
                  const journalEndTimeFormatted = formatTime(journalEndTime);
                  const memberName = journal.회원명;
                  
                  showCustomAlert(`${memberName}(${memberNumber}) 회원님의 기존 일지 (${journalStartTimeFormatted}~${journalEndTimeFormatted})와 시간이 중복됩니다.`);
                  return false;
              }
          }
          
          return true;
      }
        
      function validateJournalInputs() {
          const requiredFields = [
            { id: "journalDate", name: "날짜" },
            { id: "journalStartTime", name: "시작시간" },
            { id: "journalEndTime", name: "종료시간" },
            { id: "journalActivityName", name: "활동명" },
            { id: "journalCode", name: "소분류코드" },
            { id: "journalManager", name: "직원명" },
            { id: "journalMemberNumber", name: "회원번호" },
            { id: "journalName", name: "회원명" },
            { id: "journalObservations", name: "관찰사항" }
          ];

          for (const field of requiredFields) {
            const value = document.getElementById(field.id).value.trim();
            if (!value) {
              showCustomAlert(`${field.name}을(를) 입력해주세요.`);
              document.getElementById(field.id).focus();
            return false;
          }
        }

          const timeRegex = /^([0-1][0-9]|2[0-3])[0-5][0-9]$/;
          let startTime = document.getElementById("journalStartTime").value.padStart(4, '0');
          let endTime = document.getElementById("journalEndTime").value.padStart(4, '0');

          if (!timeRegex.test(startTime)) {
            showCustomAlert("시작시간을 올바른 형식(HHMM)으로 입력해주세요.\n예: 0900, 1330");
            document.getElementById("journalStartTime").focus();
            return false;
          }

          if (!timeRegex.test(endTime)) {
            showCustomAlert("종료시간을 올바른 형식(HHMM)으로 입력해주세요.\n예: 0900, 1330");
            document.getElementById("journalEndTime").focus();
            return false;
          }

          if (parseInt(startTime) >= parseInt(endTime)) {
            showCustomAlert("종료시간은 시작시간보다 늦어야 합니다.");
            document.getElementById("journalEndTime").focus();
            return false;
          }

          const scoreFields = [
            { id: "journalParticipation", name: "참여도" },
            { id: "journalPerformance", name: "수행도" },
            { id: "journalSatisfaction", name: "만족도" }
          ];

          for (const field of scoreFields) {
            const value = parseInt(document.getElementById(field.id).value);
            if (isNaN(value) || value < 0 || value > 5) {
              showCustomAlert(`${field.name}는 0에서 5 사이의 값이어야 합니다.`);
              document.getElementById(field.id).focus();
              return false;
            }
          }
          
          if (!checkRightTimeAndMemberNum()) {
            return false;
          }

        return true;
      }
       
      function resetAllFields() {
          document.getElementById("journalID").value = "";
          document.getElementById("journalDate").value = "";
          document.getElementById("journalStartTime").value = "";
          document.getElementById("journalEndTime").value = "";
          document.getElementById("journalEmployeeNumber").value = "";
          document.getElementById("journalManager").value = "";
          document.getElementById("journalActivityName").value = "";
          document.getElementById("journalCode").value = "";
          document.getElementById("journalMemberNumber").value = "";
          document.getElementById("journalName").value = "";
          document.getElementById("journalParticipation").value = "5";
          document.getElementById("journalPerformance").value = "5";
          document.getElementById("journalSatisfaction").value = "5";
          document.getElementById("journalObservations").value = "";

          updateButtonStates(true, false, false);
      }
      
      async function appendJournal_id() {
          
          if (!validateJournalInputs()) {
              return false;
          }
          
          const journalData = {
              날짜: parseInt(document.getElementById("journalDate").value),
              시작시간: document.getElementById("journalStartTime").value,
              종료시간: document.getElementById("journalEndTime").value,
              직원번호: document.getElementById("journalEmployeeNumber").value,
              직원명: document.getElementById("journalManager").value,
              활동명: document.getElementById("journalActivityName").value,
              코드: document.getElementById("journalCode").value,
              회원번호: document.getElementById("journalMemberNumber").value,
              회원명: document.getElementById("journalName").value,
              참여도: parseInt(document.getElementById("journalParticipation").value),
              수행도: parseInt(document.getElementById("journalPerformance").value),
              만족도: parseInt(document.getElementById("journalSatisfaction").value),
              관찰사항: document.getElementById("journalObservations").value
          };
          
          showLoading();
          
          try {
              const result = await appendJournal(journalData);
              
              if (result) {
                  showCustomAlert("일지가 성공적으로 저장되었습니다.");
                  
                  const currentDate = changeDate(document.getElementById("datePickerPage2").value);
                  const journalData = await getJournalAllPromise(currentDate);
                  dailyjournalAll = journalData;
                  
                  makeTable_journal();
                  
                  // 테이블 스크롤을 맨 아래로 이동
                  setTimeout(() => {
                      // 여러 방법을 시도하여 확실히 스크롤 이동
                      const journalTable = document.getElementById('daily-journal-table');
                      const journalTableContainer = journalTable ? journalTable.closest('.table-container') : null;
                      
                      if (journalTableContainer) {
                          // 방법 1: scrollTop 설정
                          journalTableContainer.scrollTop = journalTableContainer.scrollHeight;
                          
                          // 방법 2: 마지막 행으로 스크롤
                          const tbody = document.getElementById('journal-table-body');
                          const lastRow = tbody ? tbody.lastElementChild : null;
                          if (lastRow) {
                              lastRow.scrollIntoView({ behavior: 'smooth', block: 'end', inline: 'nearest' });
                          }
                      }
                  }, 300);
                  
                  resetAllFields();
                  
                  return true;
              } else {
                  showCustomAlert("일지 저장에 실패했습니다.");
                  return false;
              }
          } catch (error) {
              showCustomAlert("일지 저장 중 오류가 발생했습니다: " + error);
              return false;
          } finally {
              hideLoading();
          }
      }
      
      async function updateJournal_id() {
          const journalId = document.getElementById("journalID").value;
          
          if (!journalId) {
              showCustomAlert("수정할 일지를 선택해주세요.");
              return false;
          }

          if (!validateJournalInputs()) {
              return false;
          }

          const journalData = {
              날짜: parseInt(document.getElementById("journalDate").value),
              시작시간: document.getElementById("journalStartTime").value,
              종료시간: document.getElementById("journalEndTime").value,
              직원번호: document.getElementById("journalEmployeeNumber").value,
              직원명: document.getElementById("journalManager").value,
              활동명: document.getElementById("journalActivityName").value,
              코드: document.getElementById("journalCode").value,
              회원번호: document.getElementById("journalMemberNumber").value,
              회원명: document.getElementById("journalName").value,
              참여도: parseInt(document.getElementById("journalParticipation").value),
              수행도: parseInt(document.getElementById("journalPerformance").value),
              만족도: parseInt(document.getElementById("journalSatisfaction").value),
              관찰사항: document.getElementById("journalObservations").value
          };
          
          try {
              return new Promise((resolve) => {
                  showCustomConfirm("선택한 일지를 수정하시겠습니까?", async () => {
                      showLoading();
                      try {
                          const result = await updateJournal(journalId, journalData);
                          
                          if (result) {
                              showCustomAlert("일지가 성공적으로 수정되었습니다.");
                              
                              const currentDate = changeDate(document.getElementById("datePickerPage2").value);
                              const journalData = await getJournalAllPromise(currentDate);
                              dailyjournalAll = journalData;
                              
                              makeTable_journal();
                              
                              resetAllFields();
                              
                              resolve(true);
                          } else {
                              showCustomAlert("일지 수정에 실패했습니다.");
                              resolve(false);
                          }
                      } catch (error) {
                          showCustomAlert("일지 수정 중 오류가 발생했습니다: " + error);
                          resolve(false);
                      } finally {
                          hideLoading();
                      }
                  });
              });
          } catch (error) {
              showCustomAlert("일지 수정 중 오류가 발생했습니다: " + error);
              return false;
          }
      }

      async function deleteJournalrow_id() {
          const journalId = document.getElementById("journalID").value;
          
          if (!journalId) {
              showCustomAlert("삭제할 일지를 선택해주세요.");
              return false;
          }
          
          try {
              return new Promise((resolve) => {
                  showCustomConfirm("선택한 일지를 삭제하시겠습니까?\n삭제된 데이터는 복구할 수 없습니다.", async () => {
                      showLoading();
                      try {
                          const result = await deleteJournalRow(journalId);
                          
                          if (result) {
                              showCustomAlert("일지가 성공적으로 삭제되었습니다.");
                              
                              const currentDate = changeDate(document.getElementById("datePickerPage2").value);
                              const journalData = await getJournalAllPromise(currentDate);
                              dailyjournalAll = journalData;
                              
                              makeTable_journal();
                              
                              resetAllFields();
                              
                              resolve(true);
                          } else {
                              showCustomAlert("일지 삭제에 실패했습니다.");
                              resolve(false);
                          }
                      } catch (error) {
                          showCustomAlert("일지 삭제 중 오류가 발생했습니다: " + error);
                          resolve(false);
                      } finally {
                          hideLoading();
                      }
                  });
              });
          } catch (error) {
              showCustomAlert("일지 삭제 중 오류가 발생했습니다: " + error);
              return false;
          }
      }

      function showMemberModal() {
          const modal = document.getElementById('memberSelectModal');
          const selectedDate = changeDate(document.getElementById("datePickerPage2").value);
          
          modal.style.display = "block";
          
          updateMemberList(selectedDate);
          
          document.getElementById('memberSearchBox').focus();
      }

      function updateMemberList(selectedDate) {
          const tableBody = document.getElementById('member-list-body');
          const searchText = document.getElementById('memberSearchBox').value.toLowerCase();
          tableBody.innerHTML = '';
          
          const filteredMembers = memberall.filter(member => {
              const admissionDate = member.입소일 || '';
              const dischargeDate = member.퇴소일 || '99991231';
              const memberName = (member.회원명 || '').toLowerCase();
              const memberNumber = (member.회원번호 || '').toLowerCase();
              
              if (memberNumber === '상담회원') {
                  return false;
              }
              
              const matchesSearch = memberName.includes(searchText) || 
                                  memberNumber.includes(searchText);
              
              const meetsDateCriteria = (admissionDate === '' || selectedDate >= admissionDate) && 
                                      (dischargeDate === '' || dischargeDate === '99991231' || selectedDate <= dischargeDate);
              
              return matchesSearch && meetsDateCriteria;
          });
          
          filteredMembers.forEach(member => {
              const row = document.createElement('tr');
              
              const memberNumber = document.createElement('td');
              memberNumber.textContent = member.회원번호 || '';
              row.appendChild(memberNumber);
              
              const memberName = document.createElement('td');
              memberName.textContent = member.회원명 || '';
              row.appendChild(memberName);
              
              row.addEventListener('dblclick', () => {
                  document.getElementById('journalMemberNumber').value = member.회원번호 || '';
                  document.getElementById('journalName').value = member.회원명 || '';
                  closeMemberModal();
              });
              
              tableBody.appendChild(row);
          });
      }

      function closeMemberModal() {
          document.getElementById('memberSelectModal').style.display = "none";
      }

      let journalSortColumn = -1;
      let journalSortDirection = 'asc';
      let planSortColumn = -1;
      let planSortDirection = 'asc';

      function sortJournalTable(columnIndex) {
          const table = document.getElementById('daily-journal-table');
          const tbody = table.querySelector('tbody');
          const rows = Array.from(tbody.querySelectorAll('tr'));

          if (journalSortColumn === columnIndex) {
              journalSortDirection = journalSortDirection === 'asc' ? 'desc' : 'asc';
          } else {
              journalSortColumn = columnIndex;
              journalSortDirection = 'asc';
          }

          rows.sort((a, b) => {
              const aValue = a.cells[columnIndex].textContent;
              const bValue = b.cells[columnIndex].textContent;

              if (!isNaN(aValue) && !isNaN(bValue)) {
                  return journalSortDirection === 'asc' 
                      ? Number(aValue) - Number(bValue)
                      : Number(bValue) - Number(aValue);
              }

              return journalSortDirection === 'asc'
                  ? aValue.localeCompare(bValue)
                  : bValue.localeCompare(aValue);
          });

          rows.forEach(row => tbody.appendChild(row));
      }

      function sortPlanSummaryTable(columnIndex) {
          const table = document.getElementById('daily-plan-summary-table');
          const tbody = table.querySelector('tbody');
          const rows = Array.from(tbody.querySelectorAll('tr'));

          if (planSortColumn === columnIndex) {
              planSortDirection = planSortDirection === 'asc' ? 'desc' : 'asc';
          } else {
              planSortColumn = columnIndex;
              planSortDirection = 'asc';
          }

          rows.sort((a, b) => {
              const aValue = a.cells[columnIndex].textContent;
              const bValue = b.cells[columnIndex].textContent;

              if (!isNaN(aValue) && !isNaN(bValue)) {
                  return planSortDirection === 'asc' 
                      ? Number(aValue) - Number(bValue)
                      : Number(bValue) - Number(aValue);
              }

              return planSortDirection === 'asc'
                  ? aValue.localeCompare(bValue)
                  : bValue.localeCompare(aValue);
          });

          rows.forEach(row => tbody.appendChild(row));
      }

      function filterJournalByEmployee() {
          const employeeFilter = document.getElementById('employeeFilter').value.trim();
          
          const selectedDate = changeDate(document.getElementById("datePickerPage2").value);
          if (!selectedDate) {
              return;
          }
          
          const tableBody = document.getElementById('journal-table-body');
          tableBody.innerHTML = '';
          
          let filteredJournals = dailyjournalAll;
          
          if (employeeFilter !== '') {
              filteredJournals = filteredJournals.filter((journal) => {
                  return String(journal.직원번호 || '').includes(employeeFilter) || 
                         String(journal.직원명 || '').toLowerCase().includes(employeeFilter.toLowerCase());
              });
          }
          
          if (filteredJournals.length === 0) {
              const row = document.createElement('tr');
              const cell = document.createElement('td');
              cell.colSpan = 12;
              cell.textContent = employeeFilter ? 
                                '해당 직원의 일지 데이터가 없습니다.' : 
                                '해당 날짜의 일지 데이터가 없습니다.';
              cell.style.textAlign = 'center';
              cell.style.padding = '10px';
              row.appendChild(cell);
              tableBody.appendChild(row);
              return;
          }
          
          filteredJournals.sort((a, b) => {
              const startTimeA = String(a.시작시간 || '').padStart(4, '0');
              const startTimeB = String(b.시작시간 || '').padStart(4, '0');
              const timeA = timeToNumber(startTimeA);
              const timeB = timeToNumber(startTimeB);
              const timeCompare = timeA - timeB;
              
              if (timeCompare === 0) {
                  const managerA = String(a.직원명 || '');
                  const managerB = String(b.직원명 || '');
                  return managerA.localeCompare(managerB);
              }
              
              return timeCompare;
          });
          
          filteredJournals.forEach(journal => {
              const row = document.createElement('tr');
              
              const columns = ['날짜', '시작시간', '종료시간', '직원명', '활동명', '코드', '회원번호', '회원명', '참여도', '수행도', '만족도', '관찰사항'];
              
              columns.forEach(key => {
                  const cell = document.createElement('td');
                  if (key === '날짜') {
                      cell.textContent = journal[key] || '';
                  } else if (key === '시작시간' || key === '종료시간') {
                      cell.textContent = String(journal[key] || '').padStart(4, '0');
                  } else {
                      cell.textContent = journal[key] || '';
                  }
                  row.appendChild(cell);
              });
              
              row.addEventListener('dblclick', () => {
                  resetAllFields();
                  document.getElementById('journalID').value = journal.일지_id || '';
                  document.getElementById('journalDate').value = journal.날짜 || '';
                  document.getElementById('journalStartTime').value = String(journal.시작시간 || '').padStart(4, '0');
                  document.getElementById('journalEndTime').value = String(journal.종료시간 || '').padStart(4, '0');
                  document.getElementById('journalEmployeeNumber').value = journal.직원번호 || '';
                  document.getElementById('journalManager').value = journal.직원명 || '';
                  document.getElementById('journalActivityName').value = journal.활동명 || '';
                  document.getElementById('journalCode').value = journal.코드 || '';
                  document.getElementById('journalMemberNumber').value = journal.회원번호 || '';
                  document.getElementById('journalName').value = journal.회원명 || '';
                  document.getElementById('journalParticipation').value = journal.참여도 || '5';
                  document.getElementById('journalPerformance').value = journal.수행도 || '5';
                  document.getElementById('journalSatisfaction').value = journal.만족도 || '5';
                  document.getElementById('journalObservations').value = journal.관찰사항 || '';
                  
                  updateButtonStates(false, true, true);
              });
              
              tableBody.appendChild(row);
          });
      }
      
      function filterJournalAndPlanByEmployee() {
          filterJournalByEmployee();
          
          filterPlanByEmployee();
      }

      document.getElementById('employeeFilter').addEventListener('keyup', filterJournalAndPlanByEmployee);
      
      function filterPlanByEmployee() {
          const employeeFilter = document.getElementById('employeeFilter').value.trim();
          
          const selectedDate = changeDate(document.getElementById("datePickerPage2").value);
          if (!selectedDate) {
              return;
          }
          
          const tableBody = document.getElementById('plan-table-body');
          tableBody.innerHTML = '';
          
          let filteredPlans = dailyPlanAll;
          
          if (employeeFilter !== '') {
              filteredPlans = filteredPlans.filter((plan) => {
                  return String(plan.직원번호 || '').includes(employeeFilter) || 
                         String(plan.직원명 || '').toLowerCase().includes(employeeFilter.toLowerCase());
              });
          }
          
          if (filteredPlans.length === 0) {
              const row = document.createElement('tr');
              const cell = document.createElement('td');
              cell.colSpan = 6;
              cell.textContent = employeeFilter ? 
                                 '해당 직원의 계획 데이터가 없습니다.' : 
                                 '해당 날짜의 계획 데이터가 없습니다.';
              cell.style.textAlign = 'center';
              cell.style.padding = '10px';
              row.appendChild(cell);
              tableBody.appendChild(row);
              return;
          }
          
          filteredPlans.sort((a, b) => {
              const startTimeA = String(a.시작시간 || '').padStart(4, '0');
              const startTimeB = String(b.시작시간 || '').padStart(4, '0');
              const timeA = timeToNumber(startTimeA);
              const timeB = timeToNumber(startTimeB);
              const timeCompare = timeA - timeB;
              
              if (timeCompare === 0) {
                  const managerA = String(a.직원명 || '');
                  const managerB = String(b.직원명 || '');
                  return managerA.localeCompare(managerB);
              }
              
              return timeCompare;
          });
          
          filteredPlans.forEach(plan => {
              const row = document.createElement('tr');
              
              const columns = ['날짜', '시작시간', '종료시간', '직원명', '활동명', '생활영역'];
              
              columns.forEach(key => {
                  const cell = document.createElement('td');
                  if (key === '날짜') {
                      cell.textContent = plan[key] || '';
                  } else if (key === '시작시간' || key === '종료시간') {
                      cell.textContent = String(plan[key] || '').padStart(4, '0');
                  } else {
                      cell.textContent = plan[key] || '';
                  }
                  row.appendChild(cell);
              });
              
              row.addEventListener('dblclick', () => {
                  resetAllFields();
                  document.getElementById('journalDate').value = plan.날짜 || '';
                  document.getElementById('journalStartTime').value = String(plan.시작시간 || '').padStart(4, '0');
                  document.getElementById('journalEndTime').value = String(plan.종료시간 || '').padStart(4, '0');
                  document.getElementById('journalEmployeeNumber').value = plan.직원번호 || '';
                  document.getElementById('journalManager').value = plan.직원명 || '';
                  document.getElementById('journalActivityName').value = plan.활동명 || '';
                  document.getElementById('journalCode').value = plan.생활영역 || '';
              });
              
              tableBody.appendChild(row);
          });
      }
    </script>
  </body>
</html>